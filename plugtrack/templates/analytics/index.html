{% extends "base.html" %}

{% block title %}Analytics - PlugTrack{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .metric-card {
        transition: transform 0.2s;
    }
    .metric-card:hover {
        transform: translateY(-2px);
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 2rem;
    }
    
    .card-header[data-bs-toggle="collapse"] {
        transition: background-color 0.2s ease;
    }
    
    .card-header[data-bs-toggle="collapse"]:hover {
        background-color: #e9ecef !important;
    }
    
    .card-header[data-bs-toggle="collapse"] .bi-chevron-down,
    .card-header[data-bs-toggle="collapse"] .bi-chevron-up {
        transition: transform 0.2s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="bi bi-graph-up"></i> Analytics Dashboard</h1>
        <p class="text-muted">Detailed insights into your EV charging patterns and costs.</p>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center" 
                 style="cursor: pointer;" 
                 data-bs-toggle="collapse" 
                 data-bs-target="#analyticsFilters" 
                 aria-expanded="false" 
                 aria-controls="analyticsFilters">
                <h5 class="mb-0"><i class="bi bi-funnel"></i> Filters</h5>
                <i class="bi bi-chevron-down" id="analyticsFiltersChevron"></i>
            </div>
            <div class="collapse" id="analyticsFilters">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('analytics.index') }}" id="filters-form">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="date_from" class="form-label">Date From</label>
                                <input type="date" class="form-control" id="date_from" name="date_from" 
                                       value="{{ date_from.strftime('%Y-%m-%d') if date_from }}">
                            </div>
                            <div class="col-md-3">
                                <label for="date_to" class="form-label">Date To</label>
                                <input type="date" class="form-control" id="date_to" name="date_to" 
                                       value="{{ date_to.strftime('%Y-%m-%d') if date_to }}">
                            </div>
                            <div class="col-md-3">
                                <label for="car_id" class="form-label">Car</label>
                                <select class="form-select" id="car_id" name="car_id">
                                    <option value="">All Cars</option>
                                    {% for car in cars %}
                                    <option value="{{ car.id }}" {% if selected_car and selected_car.id == car.id %}selected{% endif %}>
                                        {{ car.display_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="exclude_preconditioning" 
                                           name="exclude_preconditioning" value="true" 
                                           {% if exclude_preconditioning %}checked{% endif %}>
                                    <label class="form-check-label" for="exclude_preconditioning">
                                        Exclude preconditioning sessions
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-search"></i> Apply Filters
                                    </button>
                                    <a href="{{ url_for('analytics.export') }}?{{ request.query_string.decode() }}" 
                                       class="btn btn-outline-secondary">
                                        <i class="bi bi-download"></i> Export CSV
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card text-center metric-card">
            <div class="card-body">
                <i class="bi bi-battery-charging text-primary" style="font-size: 1.5rem;"></i>
                <h5 class="mt-2">{{ metrics.total_sessions }}</h5>
                <p class="text-muted small mb-0">Sessions</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center metric-card">
            <div class="card-body">
                <i class="bi bi-lightning text-warning" style="font-size: 1.5rem;"></i>
                <h5 class="mt-2">{{ "%.1f"|format(metrics.total_kwh) }}</h5>
                <p class="text-muted small mb-0">kWh Delivered</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center metric-card">
            <div class="card-body">
                <i class="bi bi-currency-pound text-success" style="font-size: 1.5rem;"></i>
                <h5 class="mt-2">{{ "%.2f"|format(metrics.total_cost) }}</h5>
                <p class="text-muted small mb-0">Total Cost</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center metric-card">
            <div class="card-body">
                <i class="bi bi-speedometer2 text-info" style="font-size: 1.5rem;"></i>
                <h5 class="mt-2">{{ "%.2f"|format(metrics.avg_cost_per_kwh) }}</h5>
                <p class="text-muted small mb-0">Avg £/kWh</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center metric-card">
            <div class="card-body">
                <i class="bi bi-arrow-right-circle text-danger" style="font-size: 1.5rem;"></i>
                <h5 class="mt-2">{{ "%.1f"|format(metrics.total_miles) }}</h5>
                <p class="text-muted small mb-0">Miles Gained</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center metric-card">
            <div class="card-body">
                <i class="bi bi-arrow-right-circle text-danger" style="font-size: 1.5rem;"></i>
                <h5 class="mt-2">{{ "%.2f"|format(metrics.avg_cost_per_mile) }}</h5>
                <p class="text-muted small mb-0">£/Mile</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Cost per Mile Trend</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="costPerMileChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> Energy Delivered (AC/DC)</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="energyDeliveredChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-speedometer2"></i> Weighted Efficiency Trend (mi/kWh)</h5>
                <small class="text-muted">kWh-weighted to reduce noise from small sessions</small>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="efficiencyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Home vs Public Charging</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="homePublicChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- P6-5: Leaderboards & Seasonal Analytics -->
<div class="row mb-4">
    <div class="col-12">
        <h3 class="text-muted mb-3">
            <i class="bi bi-trophy"></i> Advanced Analytics
            <small class="text-muted ms-2">Seasonal trends and location insights</small>
        </h3>
    </div>
</div>

<!-- Seasonal Efficiency Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-thermometer"></i> Seasonal Efficiency vs Temperature
                    <small class="text-muted ms-2">How temperature affects your charging efficiency</small>
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="seasonalTempChart"></canvas>
                </div>
                <div class="text-center">
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i>
                        Lower temperatures may reduce efficiency due to battery preconditioning and cabin heating
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Location Leaderboard Chart -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-geo-alt"></i> Location Leaderboard
                    <small class="text-muted d-block">Best charging locations by cost per mile</small>
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="locationLeaderboardChart"></canvas>
                </div>
                <div class="text-center">
                    <small class="text-muted">
                        <i class="bi bi-star"></i>
                        Lower bars = better value charging locations
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- SoC Sweet Spot Chart -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bullseye"></i> SoC Sweet Spot
                    <small class="text-muted d-block">Optimal charging windows by efficiency</small>
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="socSweetSpotChart"></canvas>
                </div>
                <div class="text-center">
                    <small class="text-muted">
                        <i class="bi bi-lightning-charge"></i>
                        Higher bars = more efficient charging ranges
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Selected Car Info -->
{% if selected_car %}
<div class="row">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-car-front"></i> Selected Car: {{ selected_car.display_name }}</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <p class="mb-1"><strong>Battery:</strong> {{ selected_car.battery_kwh }} kWh</p>
                        {% if selected_car.efficiency_mpkwh %}
                        <p class="mb-1"><strong>Efficiency:</strong> {{ selected_car.efficiency_mpkwh }} mi/kWh</p>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <p class="mb-1"><strong>Recommended 100% Charge:</strong></p>
                        <p class="text-muted">{{ selected_car.frequency_display }}</p>
                    </div>
                    <div class="col-md-4">
                        <p class="mb-1"><strong>Current Period:</strong></p>
                        <p class="text-muted">{{ date_from.strftime('%Y-%m-%d') }} to {{ date_to.strftime('%Y-%m-%d') }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
// Chart.js configuration with theme support
const chartColors = {
    light: {
        primary: '#0d6efd',
        secondary: '#6c757d',
        success: '#198754',
        danger: '#dc3545',
        warning: '#ffc107',
        info: '#0dcaf0',
        text: '#212529',
        grid: '#dee2e6',
        background: '#ffffff'
    },
    dark: {
        primary: '#6ea8fe',
        secondary: '#adb5bd',
        success: '#75b798',
        danger: '#f1aeb5',
        warning: '#ffda6a',
        info: '#6edff6',
        text: '#f8f9fa',
        grid: '#495057',
        background: '#212529'
    }
};

// Get current theme colors
function getChartColors() {
    const theme = window.getCurrentTheme ? window.getCurrentTheme() : 'light';
    return chartColors[theme] || chartColors.light;
}

// Chart instances storage
const chartInstances = {};

// Chart creation function
function createChart(canvasId, config) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    const colors = getChartColors();
    
    // Apply theme colors to config
    const themedConfig = JSON.parse(JSON.stringify(config));
    themedConfig.options.scales = themedConfig.options.scales || {};
    themedConfig.options.scales.x = themedConfig.options.scales.x || {};
    themedConfig.options.scales.y = themedConfig.options.scales.y || {};
    
    // Apply theme colors to scales
    themedConfig.options.scales.x.ticks = themedConfig.options.scales.x.ticks || {};
    themedConfig.options.scales.x.ticks.color = colors.text;
    themedConfig.options.scales.x.grid = themedConfig.options.scales.x.grid || {};
    themedConfig.options.scales.x.grid.color = colors.grid;
    
    themedConfig.options.scales.y.ticks = themedConfig.options.scales.y.ticks || {};
    themedConfig.options.scales.y.ticks.color = colors.text;
    themedConfig.options.scales.y.grid = themedConfig.options.scales.y.grid || {};
    themedConfig.options.scales.y.grid.color = colors.grid;
    
    // Apply theme colors to title
    if (themedConfig.options.scales.y.title) {
        themedConfig.options.scales.y.title.color = colors.text;
    }
    
    // Apply theme colors to legend
    if (themedConfig.options.plugins && themedConfig.options.plugins.legend) {
        themedConfig.options.plugins.legend.labels = themedConfig.options.plugins.legend.labels || {};
        themedConfig.options.plugins.legend.labels.color = colors.text;
    }
    
    // Apply theme colors to datasets
    themedConfig.data.datasets.forEach(dataset => {
        if (dataset.borderColor && typeof dataset.borderColor === 'string') {
            dataset.borderColor = dataset.borderColor.replace(/#[0-9a-f]{6}/i, (match) => {
                const colorMap = {
                    '#0d6efd': colors.primary,
                    '#6c757d': colors.secondary,
                    '#198754': colors.success,
                    '#dc3545': colors.danger,
                    '#ffc107': colors.warning,
                    '#0dcaf0': colors.info
                };
                return colorMap[match] || match;
            });
        }
        if (dataset.backgroundColor && typeof dataset.backgroundColor === 'string') {
            dataset.backgroundColor = dataset.backgroundColor.replace(/#[0-9a-f]{6}/i, (match) => {
                const colorMap = {
                    '#0d6efd': colors.primary,
                    '#6c757d': colors.secondary,
                    '#198754': colors.success,
                    '#dc3545': colors.danger,
                    '#ffc107': colors.warning,
                    '#0dcaf0': colors.info
                };
                return colorMap[match] || match;
            });
        }
    });
    
    const chart = new Chart(ctx, themedConfig);
    chartInstances[canvasId] = chart;
    return chart;
}

// Cost per Mile Chart
createChart('costPerMileChart', {
    type: 'line',
    data: {
        labels: {{ chart_data.dates | tojson }},
        datasets: [{
            label: 'Cost per Mile (£)',
            data: {{ chart_data.cost_per_mile | tojson }},
            borderColor: '#dc3545',
            backgroundColor: '#dc354520',
            tension: 0.1,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Cost per Mile (£)'
                }
            }
        }
    }
});

// Energy Delivered Chart
createChart('energyDeliveredChart', {
    type: 'bar',
    data: {
        labels: {{ chart_data.dates | tojson }},
        datasets: [{
            label: 'AC Charging',
            data: {{ chart_data.energy_delivered | tojson }},
            backgroundColor: '#19875480',
            borderColor: '#198754',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'kWh Delivered'
                }
            }
        }
    }
});

// Efficiency Chart
createChart('efficiencyChart', {
    type: 'line',
    data: {
        labels: {{ chart_data.dates | tojson }},
        datasets: [{
            label: 'Weighted Efficiency (mi/kWh)',
            data: {{ chart_data.efficiency | tojson }},
            borderColor: '#0dcaf0',
            backgroundColor: '#0dcaf020',
            tension: 0.1,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Weighted Efficiency (mi/kWh)'
                }
            }
        }
    }
});

// Home vs Public Chart
createChart('homePublicChart', {
    type: 'doughnut',
    data: {
        labels: ['Home', 'Public'],
        datasets: [{
            data: [
                {{ metrics.home_public_split.home.percentage | round(1) }},
                {{ metrics.home_public_split.public.percentage | round(1) }}
            ],
            backgroundColor: ['#198754', '#ffc107'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// P6-5: Seasonal Efficiency vs Temperature Chart
const seasonalTempCtx = document.getElementById('seasonalTempChart').getContext('2d');

// Fetch seasonal data from API
fetch('/api/analytics/seasonal?car_id={{ selected_car.id if selected_car else "" }}')
    .then(response => response.json())
    .then(data => {
        const tempBins = data.temperature_bins || [];
        const labels = tempBins.map(bin => bin.range);
        const efficiency = tempBins.map(bin => bin.avg_efficiency);
        
        new Chart(seasonalTempCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Average Efficiency (mi/kWh)',
                    data: efficiency,
                    backgroundColor: efficiency.map((value, index) => {
                        // Color coding based on efficiency
                        const maxEff = Math.max(...efficiency);
                        const ratio = value / maxEff;
                        const alpha = Math.max(0.3, ratio);
                        return chartColors.info + Math.round(alpha * 255).toString(16).padStart(2, '0');
                    }),
                    borderColor: chartColors.info,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const bin = tempBins[context.dataIndex];
                                return [
                                    `Efficiency: ${context.parsed.y.toFixed(2)} mi/kWh`,
                                    `Sessions: ${bin.session_count}`,
                                    `Temperature: ${bin.range}`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Temperature Range'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Average Efficiency (mi/kWh)'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Error fetching seasonal data:', error);
        seasonalTempCtx.canvas.parentElement.innerHTML = '<p class="text-muted text-center py-4"><i class="bi bi-exclamation-triangle"></i> Unable to load seasonal data</p>';
    });

// P6-5: Location Leaderboard Chart
const locationLeaderboardCtx = document.getElementById('locationLeaderboardChart').getContext('2d');

fetch('/api/analytics/leaderboard?car_id={{ selected_car.id if selected_car else "" }}')
    .then(response => response.json())
    .then(data => {
        const locations = data.locations || [];
        const labels = locations.map(loc => loc.location || 'Unknown');
        const costPerMile = locations.map(loc => loc.median_p_per_mile || 0);
        
        new Chart(locationLeaderboardCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Avg Cost per Mile (p)',
                    data: costPerMile,
                    backgroundColor: costPerMile.map((value, index) => {
                        // Color coding: green for cheaper, red for expensive
                        const maxCost = Math.max(...costPerMile);
                        const minCost = Math.min(...costPerMile);
                        const ratio = (value - minCost) / (maxCost - minCost);
                        if (ratio < 0.33) return chartColors.success + '80';
                        if (ratio < 0.66) return chartColors.warning + '80';
                        return chartColors.danger + '80';
                    }),
                    borderColor: costPerMile.map((value, index) => {
                        const maxCost = Math.max(...costPerMile);
                        const minCost = Math.min(...costPerMile);
                        const ratio = (value - minCost) / (maxCost - minCost);
                        if (ratio < 0.33) return chartColors.success;
                        if (ratio < 0.66) return chartColors.warning;
                        return chartColors.danger;
                    }),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const location = locations[context.dataIndex];
                                return [
                                    `Cost per Mile: ${context.parsed.y.toFixed(1)}p`,
                                    `Sessions: ${location.session_count || 0}`,
                                    `Cost per kWh: ${(location.median_p_per_kwh || 0).toFixed(1)}p`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Charging Location'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Average Cost per Mile (pence)'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Error fetching leaderboard data:', error);
        locationLeaderboardCtx.canvas.parentElement.innerHTML = '<p class="text-muted text-center py-4"><i class="bi bi-exclamation-triangle"></i> Unable to load location data</p>';
    });

// P6-5: SoC Sweet Spot Chart
const socSweetSpotCtx = document.getElementById('socSweetSpotChart').getContext('2d');

fetch('/api/analytics/sweetspot?car_id={{ selected_car.id if selected_car else "" }}')
    .then(response => response.json())
    .then(data => {
        const socWindows = data.soc_windows || [];
        const labels = socWindows.map(window => window.soc_range || 'Unknown');
        const efficiency = socWindows.map(window => window.avg_efficiency || 0);
        
        new Chart(socSweetSpotCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Avg Efficiency (mi/kWh)',
                    data: efficiency,
                    backgroundColor: efficiency.map((value, index) => {
                        // Color coding: blue shades based on efficiency
                        const maxEff = Math.max(...efficiency);
                        const ratio = value / maxEff;
                        const alpha = Math.max(0.3, ratio);
                        return chartColors.info + Math.round(alpha * 255).toString(16).padStart(2, '0');
                    }),
                    borderColor: chartColors.info,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const window = socWindows[context.dataIndex];
                                return [
                                    `Efficiency: ${context.parsed.y.toFixed(2)} mi/kWh`,
                                    `Sessions: ${window.session_count || 0}`,
                                    `SoC Range: ${window.soc_range || 'Unknown'}`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'SoC Window'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Average Efficiency (mi/kWh)'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Error fetching sweet spot data:', error);
        socSweetSpotCtx.canvas.parentElement.innerHTML = '<p class="text-muted text-center py-4"><i class="bi bi-exclamation-triangle"></i> Unable to load SoC data</p>';
    });

// Auto-refresh charts when filters change
document.getElementById('filters-form').addEventListener('change', function() {
    // This could be enhanced to use AJAX to refresh charts without page reload
    // For now, the form submission will refresh the page with new data
});

// Make recommendations available to the global recommendations dropdown
window.recommendations = {{ recommendations|tojson|safe }};

document.addEventListener('DOMContentLoaded', function() {
    // Handle analytics filters collapse/expand
    const analyticsFilters = document.getElementById('analyticsFilters');
    const analyticsFiltersChevron = document.getElementById('analyticsFiltersChevron');
    
    if (analyticsFilters && analyticsFiltersChevron) {
        analyticsFilters.addEventListener('show.bs.collapse', function() {
            analyticsFiltersChevron.classList.remove('bi-chevron-down');
            analyticsFiltersChevron.classList.add('bi-chevron-up');
        });
        
        analyticsFilters.addEventListener('hide.bs.collapse', function() {
            analyticsFiltersChevron.classList.remove('bi-chevron-up');
            analyticsFiltersChevron.classList.add('bi-chevron-down');
        });
    }
    
    // Update recommendations dropdown
    if (typeof updateRecommendationsDropdown === 'function') {
        updateRecommendationsDropdown(window.recommendations);
    }
    
    // Reset recommendations viewed state when new data is loaded
    // This ensures the counter reappears when recommendations change
    if (window.recommendations && window.recommendations.length > 0) {
        const recommendationsHash = JSON.stringify(window.recommendations.map(r => ({ title: r.title, message: r.message })));
        const lastViewedHash = localStorage.getItem('lastViewedRecommendationsHash');
        
        // If recommendations have changed, reset the viewed state
        if (lastViewedHash !== recommendationsHash) {
            if (typeof resetRecommendationsViewed === 'function') {
                resetRecommendationsViewed();
            }
        }
    }
});

// Theme change listener for chart re-rendering
document.addEventListener('themeChanged', function(event) {
    // Re-render all charts with new theme colors
    Object.keys(chartInstances).forEach(canvasId => {
        const chart = chartInstances[canvasId];
        if (chart) {
            const colors = getChartColors();
            
            // Update chart colors
            chart.options.scales.x.ticks.color = colors.text;
            chart.options.scales.x.grid.color = colors.grid;
            chart.options.scales.y.ticks.color = colors.text;
            chart.options.scales.y.grid.color = colors.grid;
            
            if (chart.options.scales.y.title) {
                chart.options.scales.y.title.color = colors.text;
            }
            
            if (chart.options.plugins && chart.options.plugins.legend) {
                chart.options.plugins.legend.labels.color = colors.text;
            }
            
            // Update dataset colors
            chart.data.datasets.forEach(dataset => {
                if (dataset.borderColor && typeof dataset.borderColor === 'string') {
                    dataset.borderColor = dataset.borderColor.replace(/#[0-9a-f]{6}/i, (match) => {
                        const colorMap = {
                            '#0d6efd': colors.primary,
                            '#6c757d': colors.secondary,
                            '#198754': colors.success,
                            '#dc3545': colors.danger,
                            '#ffc107': colors.warning,
                            '#0dcaf0': colors.info
                        };
                        return colorMap[match] || match;
                    });
                }
                if (dataset.backgroundColor && typeof dataset.backgroundColor === 'string') {
                    dataset.backgroundColor = dataset.backgroundColor.replace(/#[0-9a-f]{6}/i, (match) => {
                        const colorMap = {
                            '#0d6efd': colors.primary,
                            '#6c757d': colors.secondary,
                            '#198754': colors.success,
                            '#dc3545': colors.danger,
                            '#ffc107': colors.warning,
                            '#0dcaf0': colors.info
                        };
                        return colorMap[match] || match;
                    });
                }
            });
            
            chart.update();
        }
    });
});
</script>
{% endblock %}
