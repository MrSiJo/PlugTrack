{% extends "base.html" %}

{% from 'charging_sessions/_detail_drawer.html' import render_session_detail_drawer %}
{% from 'charging_sessions/_blend_planner.html' import render_blend_planner %}

{% block title %}Charging Sessions - PlugTrack{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h1><i class="bi bi-battery-charging"></i> Charging Sessions</h1>
        <div>
            <a href="{{ url_for('charging_sessions.export') }}?{{ request.query_string.decode() }}" class="btn btn-outline-secondary btn-sm me-2">
                <i class="bi bi-download"></i> Export CSV
            </a>
            <a href="{{ url_for('charging_sessions.new') }}" class="btn btn-primary">
                <i class="bi bi-plus"></i> Add Session
            </a>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-funnel"></i> Filters</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('charging_sessions.index') }}" class="row g-3">
                    <div class="col-md-2">
                        <label for="date_from" class="form-label">Date From</label>
                        <input type="date" class="form-control" id="date_from" name="date_from" 
                               value="{{ date_from.strftime('%Y-%m-%d') if date_from }}">
                    </div>
                    <div class="col-md-2">
                        <label for="date_to" class="form-label">Date To</label>
                        <input type="date" class="form-control" id="date_to" name="date_to" 
                               value="{{ date_to.strftime('%Y-%m-%d') if date_to }}">
                    </div>
                    <div class="col-md-2">
                        <label for="car_id" class="form-label">Car</label>
                        <select class="form-select" id="car_id" name="car_id">
                            <option value="">All Cars</option>
                            {% for car in cars %}
                            <option value="{{ car.id }}" {% if selected_car_id == car.id %}selected{% endif %}>
                                {{ car.display_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="charge_type" class="form-label">Type</label>
                        <select class="form-select" id="charge_type" name="charge_type">
                            <option value="">All Types</option>
                            {% for type in charge_types %}
                            <option value="{{ type }}" {% if selected_charge_type == type %}selected{% endif %}>
                                {{ type }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="charge_network" class="form-label">Network</label>
                        <select class="form-select" id="charge_network" name="charge_network">
                            <option value="">All Networks</option>
                            {% for network in networks %}
                            <option value="{{ network }}" {% if selected_network == network %}selected{% endif %}>
                                {{ network }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Apply
                            </button>
                            <a href="{{ url_for('charging_sessions.index') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Clear
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if sessions %}
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            Showing {{ sessions|length }} charging session{{ 's' if sessions|length != 1 else '' }}
            {% if date_from or date_to or selected_car_id or selected_charge_type or selected_network %}
            with applied filters
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Car</th>
                                <th>Type</th>
                                <th>SoC Range</th>
                                <th>kWh Delivered</th>
                                <th>Cost/kWh</th>
                                <th>Total Cost</th>
                                <th>Insights</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in sessions %}
                            <tr data-session-id="{{ session.id }}" data-car-id="{{ session.car.id }}">
                                <td>{{ session.date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ session.car.display_name }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if session.charge_type == 'AC' else 'warning' }}">
                                        {{ session.charge_type }}
                                    </span>
                                </td>
                                <td>{{ session.soc_range }}</td>
                                <td>{{ "%.1f"|format(session.charge_delivered_kwh) }} kWh</td>
                                <td>{{ format_currency(session.cost_per_kwh, current_user.id) }}</td>
                                <td>{{ format_currency(session.total_cost, current_user.id) }}</td>
                                <td>
                                    <div class="insight-chips-placeholder" data-session-id="{{ session.id }}">
                                        <div class="text-center text-muted">
                                            <small>Loading insights...</small>
                                        </div>
                                    </div>
                                    <div class="small text-muted mt-1">
                                        <strong>Location:</strong> {{ session.location_label }}
                                        {% if session.charge_network %}
                                        • <strong>Network:</strong> {{ session.charge_network }}
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-info btn-sm" 
                                                onclick="showSessionDetails({{ session.id }})" 
                                                title="View Details">
                                            <i class="bi bi-info-circle"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                onclick="showBlendPlanner({{ session.id }}, {{ session.soc_from }}, {{ session.cost_per_kwh }}, {{ session.car.battery_kwh }})" 
                                                title="Simulate Blend">
                                            <i class="bi bi-lightning-charge"></i>
                                        </button>
                                        <a href="{{ url_for('charging_sessions.edit', id=session.id) }}" 
                                            class="btn btn-outline-primary btn-sm" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <form method="POST" action="{{ url_for('charging_sessions.delete', id=session.id) }}" 
                                                class="d-inline" 
                                                onsubmit="return confirm('Are you sure you want to delete this charging session?')">
                                            <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row">
    <div class="col-12">
        <div class="text-center py-5">
            <i class="bi bi-battery-charging text-muted" style="font-size: 4rem;"></i>
            <h3 class="text-muted mt-3">
                {% if date_from or date_to or selected_car_id or selected_charge_type or selected_network %}
                No sessions match your filters
                {% else %}
                No charging sessions yet
                {% endif %}
            </h3>
            <p class="text-muted">
                {% if date_from or date_to or selected_car_id or selected_charge_type or selected_network %}
                Try adjusting your filters or <a href="{{ url_for('charging_sessions.index') }}">clear all filters</a>.
                {% else %}
                Get started by adding your first charging session.
                {% endif %}
            </p>
            {% if not date_from and not date_to and not selected_car_id and not selected_charge_type and not selected_network %}
            <a href="{{ url_for('charging_sessions.new') }}" class="btn btn-primary btn-lg">
                <i class="bi bi-plus"></i> Add Your First Session
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Include the insight chips partial -->
{% include 'charging_sessions/_chips.html' %}
{{ render_session_detail_drawer() }}
{{ render_blend_planner() }}

{% endblock %}

{% block extra_scripts %}
<script>
// Global variables
let currentSessionId = null;
let currentBlendPlan = null;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadInsightChips();
    initializeModals();
});

// Initialize all modals
function initializeModals() {
    console.log('Initializing modals...');
    
    // Initialize session detail modal
    const detailModalElement = document.getElementById('sessionDetailModal');
    if (detailModalElement) {
        console.log('✓ Session detail modal found, initializing...');
        new bootstrap.Modal(detailModalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    } else {
        console.error('✗ Session detail modal not found');
    }
    
    // Initialize blend planner modal
    const blendModalElement = document.getElementById('blendPlannerModal');
    if (blendModalElement) {
        console.log('✓ Blend planner modal found, initializing...');
        new bootstrap.Modal(blendModalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    } else {
        console.error('✗ Blend planner modal not found');
    }
    
    console.log('Modal initialization complete');
}

// Load insight chips for all sessions
function loadInsightChips() {
    const placeholders = document.querySelectorAll('.insight-chips-placeholder');
    placeholders.forEach(placeholder => {
        const sessionId = placeholder.dataset.sessionId;
        loadSessionInsights(sessionId, placeholder);
    });
}

// Load insights for a specific session
function loadSessionInsights(sessionId, placeholder) {
    fetch(`/charging-sessions/${sessionId}/details`)
        .then(response => response.json())
        .then(data => {
            renderInsightChips(placeholder, data.metrics);
        })
        .catch(error => {
            console.error('Error loading insights:', error);
            placeholder.innerHTML = '<div class="text-center text-muted"><small>Error loading insights</small></div>';
        });
}

// Render insight chips
function renderInsightChips(placeholder, metrics) {
    const chipsHtml = `
        <div class="d-flex flex-wrap gap-1 mb-2">
            <!-- mi/kWh chip -->
            <span class="badge bg-info" title="Miles gained per kWh: ${metrics.miles_gained.toFixed(1)} mi / ${metrics.efficiency_used.toFixed(1)} mi/kWh">
                ${metrics.efficiency_used.toFixed(1)} mi/kWh
            </span>
            
            <!-- £/mi chip -->
            <span class="badge ${getCostBadgeClass(metrics.cost_per_mile * 100, metrics.threshold_ppm)}" 
                  title="Cost per mile: £${metrics.cost_per_mile.toFixed(3)} = ${(metrics.cost_per_mile * 100).toFixed(1)}p/mi">
                ${(metrics.cost_per_mile * 100).toFixed(1)}p/mi
            </span>
            
            <!-- %/kWh chip -->
            <span class="badge bg-secondary" title="Battery percentage added per kWh: ${metrics.battery_added_percent}% / ${metrics.percent_per_kwh.toFixed(1)}%/kWh">
                ${metrics.percent_per_kwh.toFixed(1)}%/kWh
            </span>
            
            <!-- avg kW chip -->
            ${metrics.avg_power_kw > 0 ? `
            <span class="badge bg-primary" title="Average power: ${metrics.avg_power_kw.toFixed(1)} kW">
                ${metrics.avg_power_kw.toFixed(1)} kW
            </span>
            ` : ''}
            
            <!-- Petrol comparison badge -->
            <span class="badge ${metrics.is_cheaper_than_petrol ? 'bg-success' : 'bg-danger'}" 
                  title="This charging session is ${metrics.is_cheaper_than_petrol ? 'cheaper' : 'bg-danger'} than petrol (threshold: ${metrics.threshold_ppm.toFixed(1)}p/mi)">
                ${metrics.is_cheaper_than_petrol ? '✓ cheaper' : '× dearer'}
            </span>
        </div>
    `;
    
    placeholder.innerHTML = chipsHtml;
}

// Get badge class based on cost comparison
function getCostBadgeClass(costPerMileP, thresholdPpm) {
    if (costPerMileP <= thresholdPpm * 0.75) return 'bg-success';
    if (costPerMileP <= thresholdPpm * 1.25) return 'bg-warning';
    return 'bg-danger';
}

// Show session details modal
function showSessionDetails(sessionId) {
    console.log('showSessionDetails called with sessionId:', sessionId);
    currentSessionId = sessionId;
    
    // Get the modal element
    const modalElement = document.getElementById('sessionDetailModal');
    if (!modalElement) {
        console.error('Session detail modal not found');
        return;
    }
    
    console.log('Modal element found, getting instance...');
    
    // Check if modal is already initialized
    let modal = bootstrap.Modal.getInstance(modalElement);
    if (!modal) {
        console.log('Creating new modal instance...');
        // Create new modal instance
        modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    } else {
        console.log('Using existing modal instance');
    }
    
    console.log('Showing modal...');
    modal.show();
    
    // Load session details
    loadSessionDetails(sessionId);
}

// Load session details
function loadSessionDetails(sessionId) {
    const contentDiv = document.getElementById('sessionDetailContent');
    contentDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    fetch(`/charging-sessions/${sessionId}/details`)
        .then(response => response.json())
        .then(data => {
            renderSessionDetails(data);
        })
        .catch(error => {
            console.error('Error loading session details:', error);
            contentDiv.innerHTML = '<div class="alert alert-danger">Error loading session details</div>';
        });
}

// Render session details
function renderSessionDetails(data) {
    const template = document.getElementById('sessionDetailTemplate');
    const content = template.content.cloneNode(true);
    
    // Populate summary
    content.querySelector('.session-date').textContent = data.session.date;
    content.querySelector('.session-car').textContent = data.session.car_name;
    content.querySelector('.session-type').textContent = data.session.charge_type;
    content.querySelector('.session-location').textContent = data.session.location;
    content.querySelector('.session-network').textContent = data.session.network || 'N/A';
    content.querySelector('.session-notes').textContent = data.session.notes || 'No notes';
    
    // Populate key numbers
    content.querySelector('.session-kwh').textContent = `${(data.metrics.total_cost / data.metrics.efficiency_used / 100).toFixed(1)}`;
    content.querySelector('.session-total-cost').textContent = `£${data.metrics.total_cost.toFixed(2)}`;
    content.querySelector('.session-cost-per-mile').textContent = `${(data.metrics.cost_per_mile * 100).toFixed(1)}p`;
    content.querySelector('.session-miles-gained').textContent = `${data.metrics.miles_gained.toFixed(1)} mi`;
    
    // Populate battery & power
    content.querySelector('.session-soc-range').textContent = `${data.metrics.battery_added_percent}%`;
    content.querySelector('.session-percent-per-kwh').textContent = `${data.metrics.percent_per_kwh.toFixed(1)}%`;
    content.querySelector('.session-avg-power').textContent = `${data.metrics.avg_power_kw.toFixed(1)} kW`;
    
    // Populate comparative context
    renderComparativeContext(content, data.deltas, data.rolling_averages);
    
    // Populate hints
    renderHints(content, data.hints);
    
    // Update modal content
    document.getElementById('sessionDetailContent').innerHTML = '';
    document.getElementById('sessionDetailContent').appendChild(content);
    
    // Set up button handlers
    setupDetailModalHandlers();
}

// Render comparative context
function renderComparativeContext(content, deltas, rollingAverages) {
    const contextDiv = content.querySelector('#comparativeContext');
    const template = document.getElementById('comparativeContextTemplate');
    const contextContent = template.content.cloneNode(true);
    
    // Populate vs last similar
    if (deltas.vs_last_similar) {
        const deltasDiv = contextContent.querySelector('.comparative-deltas');
        deltasDiv.innerHTML = `
            <div class="mb-2">
                <strong>Cost per mile:</strong> 
                <span class="badge ${deltas.vs_last_similar.cost_per_mile_delta > 0 ? 'bg-danger' : 'bg-success'}">
                    ${deltas.vs_last_similar.cost_per_mile_delta > 0 ? '+' : ''}${(deltas.vs_last_similar.cost_per_mile_delta * 100).toFixed(1)}p
                </span>
            </div>
            <div class="mb-2">
                <strong>Avg power:</strong> 
                <span class="badge ${deltas.vs_last_similar.avg_power_kw_delta > 0 ? 'bg-success' : 'bg-warning'}">
                    ${deltas.vs_last_similar.avg_power_kw_delta > 0 ? '+' : ''}${deltas.vs_last_similar.avg_power_kw_delta.toFixed(1)} kW
                </span>
            </div>
        `;
    }
    
    // Populate vs 30-day average
    if (deltas.vs_30_day_avg) {
        const averagesDiv = contextContent.querySelector('.rolling-averages');
        averagesDiv.innerHTML = `
            <div class="mb-2">
                <strong>Cost per mile:</strong> 
                <span class="badge ${deltas.vs_30_day_avg.cost_per_mile_delta > 0 ? 'bg-danger' : 'bg-success'}">
                    ${deltas.vs_30_day_avg.cost_per_mile_delta > 0 ? '+' : ''}${(deltas.vs_30_day_avg.cost_per_mile_delta * 100).toFixed(1)}p
                </span>
            </div>
            <div class="mb-2">
                <strong>Avg power:</strong> 
                <span class="badge ${deltas.vs_30_day_avg.avg_power_kw_delta > 0 ? 'bg-success' : 'bg-warning'}">
                    ${deltas.vs_30_day_avg.avg_power_kw_delta > 0 ? '+' : ''}${deltas.vs_30_day_avg.avg_power_kw_delta.toFixed(1)} kW
                </span>
            </div>
        `;
    }
    
    contextDiv.appendChild(contextContent);
}

// Render hints
function renderHints(content, hints) {
    const hintsDiv = content.querySelector('#sessionHints');
    const template = document.getElementById('hintTemplate');
    
    if (hints.length === 0) {
        hintsDiv.innerHTML = '<div class="alert alert-info">No hints for this session</div>';
        return;
    }
    
    hints.forEach(hint => {
        const hintContent = template.content.cloneNode(true);
        const alertDiv = hintContent.querySelector('.alert');
        
        // Replace placeholders
        alertDiv.className = alertDiv.className.replace('{type}', hint.type);
        alertDiv.dataset.hintCode = hint.code;
        alertDiv.querySelector('.bi').className = alertDiv.querySelector('.bi').className.replace('{icon}', hint.icon);
        alertDiv.querySelector('.alert-heading').textContent = hint.title;
        alertDiv.querySelector('p').textContent = hint.message;
        
        hintsDiv.appendChild(hintContent);
    });
}

// Setup detail modal handlers
function setupDetailModalHandlers() {
    // Edit button
    document.getElementById('editSessionBtn').onclick = function() {
        if (currentSessionId) {
            window.location.href = `/charging-sessions/${currentSessionId}/edit`;
        }
    };
    
    // Simulate blend button
    document.getElementById('simulateBlendBtn').onclick = function() {
        if (currentSessionId) {
            // Close detail modal and open blend planner
            const detailModal = bootstrap.Modal.getInstance(document.getElementById('sessionDetailModal'));
            if (detailModal) {
                detailModal.hide();
            }
            showBlendPlanner(currentSessionId);
        }
    };
    
    // Setup hint dismissal
    document.querySelectorAll('.hint-item').forEach(hint => {
        hint.querySelector('.btn-close').onclick = function() {
            const hintCode = hint.dataset.hintCode;
            dismissHint(currentSessionId, hintCode);
            hint.remove();
        };
    });
}

// Dismiss hint
function dismissHint(sessionId, hintCode) {
    fetch(`/charging-sessions/${sessionId}/dismiss-hint`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ hint_code: hintCode })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Hint dismissed successfully');
        }
    })
    .catch(error => {
        console.error('Error dismissing hint:', error);
    });
}

// Show blend planner modal
function showBlendPlanner(sessionId, startSoc = null, dcCostPerKwh = null, batteryKwh = null) {
    console.log('showBlendPlanner called with sessionId:', sessionId, 'startSoc:', startSoc, 'dcCostPerKwh:', dcCostPerKwh, 'batteryKwh:', batteryKwh);
    currentSessionId = sessionId;
    
    // Get the modal element
    const modalElement = document.getElementById('blendPlannerModal');
    if (!modalElement) {
        console.error('Blend planner modal not found');
        return;
    }
    
    console.log('Blend planner modal element found, getting instance...');
    
    // Check if modal is already initialized
    let modal = bootstrap.Modal.getInstance(modalElement);
    if (!modal) {
        console.log('Creating new blend planner modal instance...');
        // Create new modal instance
        modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    } else {
        console.log('Using existing blend planner modal instance');
    }
    
    // Pre-fill form if values provided
    if (startSoc !== null) {
        document.getElementById('startSoc').value = startSoc;
        
        // Ensure DC stop is higher than start SoC
        let dcStopSoc = Math.max(startSoc + 15, 60); // At least 15% higher than start, or 60% minimum
        document.getElementById('dcStopSoc').value = dcStopSoc;
        
        // Ensure home target is higher than DC stop, but never above 100%
        let homeTargetSoc = Math.min(Math.max(dcStopSoc + 20, 80), 100); // At least 20% higher than DC stop, or 80% minimum, max 100%
        document.getElementById('homeTargetSoc').value = homeTargetSoc;
    }
    
    if (dcCostPerKwh !== null) {
        document.getElementById('dcCostPerKwh').value = dcCostPerKwh;
    }
    
    if (batteryKwh !== null) {
        document.getElementById('batteryKwh').value = batteryKwh;
    }
    
    // Set default values for other fields
    document.getElementById('dcPowerKw').value = '50';
    document.getElementById('homePowerKw').value = '2.3'; // Default home charger power
    
    // Set home cost to your actual rate (this should come from settings later)
    document.getElementById('homeCostPerKwh').value = '0.2019';
    
    console.log('Showing blend planner modal...');
    modal.show();
    
    // Setup form submission
    setupBlendPlannerForm();
}

// Setup blend planner form
function setupBlendPlannerForm() {
    document.getElementById('blendPlannerForm').onsubmit = function(e) {
        e.preventDefault();
        calculateBlend();
    };
    
    // Setup real-time validation
    setupBlendValidation();
    
    // Setup close button
    document.getElementById('closeBlendBtn').onclick = function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('blendPlannerModal'));
        if (modal) {
            modal.hide();
        }
    };
    
    // Setup copy to notes button
    document.getElementById('copyToNotesBtn').onclick = function() {
        if (currentBlendPlan && currentSessionId) {
            copyBlendToNotes(currentSessionId, currentBlendPlan);
        }
    };
}

// Setup real-time validation for blend planner
function setupBlendValidation() {
    const startSocInput = document.getElementById('startSoc');
    const dcStopSocInput = document.getElementById('dcStopSoc');
    const homeTargetSocInput = document.getElementById('homeTargetSoc');
    
    // Update DC stop when start changes
    startSocInput.addEventListener('input', function() {
        const startSoc = parseInt(this.value) || 0;
        const currentDcStop = parseInt(dcStopSocInput.value) || 65;
        
        // Ensure DC stop is at least 15% higher than start
        if (currentDcStop <= startSoc) {
            const newDcStop = Math.max(startSoc + 15, 60);
            dcStopSocInput.value = newDcStop;
            
            // Also update home target if needed
            const currentHomeTarget = parseInt(homeTargetSocInput.value) || 80;
            if (currentHomeTarget <= newDcStop) {
                homeTargetSocInput.value = Math.min(Math.max(newDcStop + 20, 80), 100);
            }
        }
    });
    
    // Update home target when DC stop changes
    dcStopSocInput.addEventListener('input', function() {
        const dcStopSoc = parseInt(this.value) || 65;
        const currentHomeTarget = parseInt(homeTargetSocInput.value) || 80;
        
        // Ensure home target is at least 20% higher than DC stop
        if (currentHomeTarget <= dcStopSoc) {
            homeTargetSocInput.value = Math.min(Math.max(dcStopSoc + 20, 80), 100);
        }
    });
}

// Calculate blend
function calculateBlend() {
    // Validate SoC values first
    if (!validateBlendInputs()) {
        return;
    }
    
    const formData = new FormData(document.getElementById('blendPlannerForm'));
    const data = {
        start_soc: parseInt(formData.get('startSoc')),
        dc_stop_soc: parseInt(formData.get('dcStopSoc')),
        home_target_soc: parseInt(formData.get('homeTargetSoc')),
        dc_power_kw: parseFloat(formData.get('dcPowerKw')),
        dc_cost_per_kwh: parseFloat(formData.get('dcCostPerKwh')),
        home_cost_per_kwh: parseFloat(formData.get('homeCostPerKwh')),
        home_power_kw: parseFloat(formData.get('homePowerKw')),
        battery_kwh: parseFloat(formData.get('batteryKwh')),
        car_id: getCurrentCarId()
    };
    
    fetch('/blend/plan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        currentBlendPlan = data;
        renderBlendResults(data);
    })
    .catch(error => {
        console.error('Error calculating blend:', error);
        alert('Error calculating blend');
    });
}

// Validate blend inputs
function validateBlendInputs() {
    const startSoc = parseInt(document.getElementById('startSoc').value);
    const dcStopSoc = parseInt(document.getElementById('dcStopSoc').value);
    const homeTargetSoc = parseInt(document.getElementById('homeTargetSoc').value);
    
    if (startSoc >= dcStopSoc) {
        alert('DC Stop SoC must be higher than Start SoC');
        return false;
    }
    
    if (dcStopSoc >= homeTargetSoc) {
        alert('Home Target SoC must be higher than DC Stop SoC');
        return false;
    }
    
    if (homeTargetSoc > 100) {
        alert('Home Target SoC cannot exceed 100%');
        return false;
    }
    
    return true;
}

// Render blend results
function renderBlendResults(data) {
    document.getElementById('dcSummary').textContent = data.formatted.dc_summary;
    document.getElementById('homeSummary').textContent = data.formatted.home_summary;
    document.getElementById('totalSummary').textContent = data.formatted.total_summary;
    
    document.getElementById('blendResults').style.display = 'block';
}

// Copy blend to notes
function copyBlendToNotes(sessionId, blendPlan) {
    fetch('/blend/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: sessionId,
            blend_plan: blendPlan.blend
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Blend plan saved to session notes!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('blendPlannerModal'));
            if (modal) {
                modal.hide();
            }
        } else {
            alert('Error saving blend plan: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error saving blend plan:', error);
        alert('Error saving blend plan');
    });
}

// Get current car ID (simplified - you might want to improve this)
function getCurrentCarId() {
    // Get the car ID from the current session row
    if (currentSessionId) {
        const sessionRow = document.querySelector(`tr[data-session-id="${currentSessionId}"]`);
        if (sessionRow) {
            return sessionRow.dataset.carId;
        }
    }
    // Fallback: get from the first session row
    const firstSession = document.querySelector('tbody tr');
    if (firstSession) {
        return firstSession.dataset.carId;
    }
    return 1; // Default fallback
}
</script>
{% endblock %}
