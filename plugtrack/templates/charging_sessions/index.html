{% extends "base.html" %}

{% from 'charging_sessions/_detail_drawer.html' import render_session_detail_drawer %}
{% from 'charging_sessions/_blend_planner.html' import render_blend_planner %}

{% block title %}Charging Sessions - PlugTrack{% endblock %}

{% block extra_head %}
<style>
    .card-header[data-bs-toggle="collapse"] {
        transition: background-color 0.2s ease;
    }
    
    .card-header[data-bs-toggle="collapse"]:hover {
        background-color: #e9ecef !important;
    }
    
    .card-header[data-bs-toggle="collapse"] .bi-chevron-down,
    .card-header[data-bs-toggle="collapse"] .bi-chevron-up {
        transition: transform 0.2s ease;
    }
</style>
{% endblock %}

{% block content %}
<!-- Include the chip selector script -->
<script src="{{ url_for('static', filename='js/chip_selector.js') }}"></script>

<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h1><i class="bi bi-battery-charging"></i> Charging Sessions</h1>
        <div>
            <a href="{{ url_for('charging_sessions.export') }}?{{ request.query_string.decode() }}" class="btn btn-outline-secondary btn-sm me-2">
                <i class="bi bi-download"></i> Export CSV
            </a>
            <a href="{{ url_for('charging_sessions.new') }}" class="btn btn-primary">
                <i class="bi bi-plus"></i> Add Session
            </a>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center" 
                 style="cursor: pointer;" 
                 data-bs-toggle="collapse" 
                 data-bs-target="#sessionFilters" 
                 aria-expanded="false" 
                 aria-controls="sessionFilters">
                <h5 class="mb-0"><i class="bi bi-funnel"></i> Filters</h5>
                <i class="bi bi-chevron-{% if date_from or date_to or selected_car_id or selected_charge_type or selected_network %}up{% else %}down{% endif %}" id="sessionFiltersChevron"></i>
            </div>
            <div class="collapse {% if date_from or date_to or selected_car_id or selected_charge_type or selected_network %}show{% endif %}" id="sessionFilters">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('charging_sessions.index') }}" class="row g-3">
                        <div class="col-md-2">
                            <label for="date_from" class="form-label">Date From</label>
                            <input type="date" class="form-control" id="date_from" name="date_from" 
                                   value="{{ date_from.strftime('%Y-%m-%d') if date_from }}">
                        </div>
                        <div class="col-md-2">
                            <label for="date_to" class="form-label">Date To</label>
                            <input type="date" class="form-control" id="date_to" name="date_to" 
                                   value="{{ date_to.strftime('%Y-%m-%d') if date_to }}">
                        </div>
                        <div class="col-md-2">
                            <label for="car_id" class="form-label">Car</label>
                            <select class="form-select" id="car_id" name="car_id">
                                <option value="">All Cars</option>
                                {% for car in cars %}
                                <option value="{{ car.id }}" {% if selected_car_id == car.id %}selected{% endif %}>
                                    {{ car.display_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="charge_type" class="form-label">Type</label>
                            <select class="form-select" id="charge_type" name="charge_type">
                                <option value="">All Types</option>
                                {% for type in charge_types %}
                                <option value="{{ type }}" {% if selected_charge_type == type %}selected{% endif %}>
                                    {{ type }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="charge_network" class="form-label">Network</label>
                            <select class="form-select" id="charge_network" name="charge_network">
                                <option value="">All Networks</option>
                                {% for network in networks %}
                                <option value="{{ network }}" {% if selected_network == network %}selected{% endif %}>
                                    {{ network }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search"></i> Apply
                                </button>
                                <a href="{{ url_for('charging_sessions.index') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i> Clear
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% if sessions %}
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            Showing {{ sessions|length }} charging session{{ 's' if sessions|length != 1 else '' }}
            {% if date_from or date_to or selected_car_id or selected_charge_type or selected_network %}
            with applied filters
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Car</th>
                                <th>Type</th>
                                <th>SoC Range</th>
                                <th>kWh Delivered</th>
                                <th>Cost (p/kWh)</th>
                                <th>Total Cost</th>
                                <th>Insights</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in sessions %}
                            <tr data-session-id="{{ session.id }}" data-car-id="{{ session.car.id }}">
                                <td>
                                    {{ session.date.strftime('%Y-%m-%d') }}
                                    {% if session.is_baseline %}
                                    <br><small><span class="badge bg-secondary">baseline</span></small>
                                    {% endif %}
                                </td>
                                <td>{{ session.car.display_name }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if session.charge_type == 'AC' else 'warning' }}">
                                        {{ session.charge_type }}
                                    </span>
                                </td>
                                <td>{{ session.soc_range }}</td>
                                <td>{{ "%.1f"|format(session.charge_delivered_kwh) }} kWh</td>
                                <td>{{ format_currency(session.cost_per_kwh, current_user.id) }}</td>
                                <td>{{ format_currency(session.total_cost, current_user.id) }}</td>
                                <td>
                                    <div class="insight-chips-placeholder" data-session-id="{{ session.id }}">
                                        <div class="text-center text-muted">
                                            <small>Loading insights...</small>
                                        </div>
                                    </div>
                                    <div class="small text-muted mt-1">
                                        <strong>Location:</strong> {{ session.location_label }}
                                        {% if session.charge_network %}
                                        • <strong>Network:</strong> {{ session.charge_network }}
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-info btn-sm" 
                                                onclick="showSessionDetails({{ session.id }})" 
                                                title="Quick View">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <a href="{{ url_for('charging_sessions.session_detail_page', id=session.id) }}" 
                                           class="btn btn-outline-primary btn-sm" 
                                           title="Full Detail Page">
                                            <i class="bi bi-info-circle"></i>
                                        </a>
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                onclick="showBlendPlanner({{ session.id }}, {{ session.soc_from }}, {{ session.cost_per_kwh }}, {{ session.car.battery_kwh }})" 
                                                title="Simulate Blend">
                                            <i class="bi bi-lightning-charge"></i>
                                        </button>
                                        <a href="{{ url_for('charging_sessions.edit', id=session.id) }}" 
                                            class="btn btn-outline-primary btn-sm" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <form method="POST" action="{{ url_for('charging_sessions.delete', id=session.id) }}" 
                                                class="d-inline" 
                                                onsubmit="return confirm('Are you sure you want to delete this charging session?')">
                                            <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row">
    <div class="col-12">
        <div class="text-center py-5">
            <i class="bi bi-battery-charging text-muted" style="font-size: 4rem;"></i>
            <h3 class="text-muted mt-3">
                {% if date_from or date_to or selected_car_id or selected_charge_type or selected_network %}
                No sessions match your filters
                {% else %}
                No charging sessions yet
                {% endif %}
            </h3>
            <p class="text-muted">
                {% if date_from or date_to or selected_car_id or selected_charge_type or selected_network %}
                Try adjusting your filters or <a href="{{ url_for('charging_sessions.index') }}">clear all filters</a>.
                {% else %}
                Get started by adding your first charging session.
                {% endif %}
            </p>
            {% if not date_from and not date_to and not selected_car_id and not selected_charge_type and not selected_network %}
            <a href="{{ url_for('charging_sessions.new') }}" class="btn btn-primary btn-lg">
                <i class="bi bi-plus"></i> Add Your First Session
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Include the insight chips partial -->
{% include 'charging_sessions/_chips.html' %}
{{ render_session_detail_drawer() }}
{{ render_blend_planner() }}

{% endblock %}

{% block extra_scripts %}
<script>
// User-friendly confidence reason mappings (P6-3)
function getUserFriendlyReason(technicalReason) {
    const reasonMappings = {
        'small_window': 'Short trip',
        'stale_anchors': 'Old data',
        'outlier_clamped': 'Unusual reading',
        'Small charging window': 'Short trip',
        'No odometer data': 'Missing mileage',
        'No efficiency data': 'No efficiency',
        'Free session - no cost analysis': 'Free charge',
        'Baseline session': 'Setup session',
        'Small energy delivery': 'Small charge'
    };
    
    // Extract base reason (remove parameters in parentheses)
    const baseReason = technicalReason.split('(')[0].trim();
    
    return reasonMappings[baseReason] || 
           reasonMappings[technicalReason] || 
           baseReason.replace('_', ' ');
}

function getFriendlyReasonBadgeClass(technicalReason) {
    if (technicalReason.includes('small_window') || technicalReason.includes('Small charging window') || technicalReason.includes('Small energy delivery')) {
        return 'bg-warning';
    } else if (technicalReason.includes('stale_anchors') || technicalReason.includes('Old data')) {
        return 'bg-info';
    } else if (technicalReason.includes('outlier') || technicalReason.includes('Unusual reading')) {
        return 'bg-danger';
    } else if (technicalReason.includes('No ') || technicalReason.includes('Missing')) {
        return 'bg-secondary';
    } else if (technicalReason.includes('Free') || technicalReason.includes('Baseline')) {
        return 'bg-success';
    }
    return 'bg-secondary';
}

// Global variables
let currentSessionId = null;
let currentBlendPlan = null;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadInsightChips();
    initializeModals();
    
    // Handle session filters collapse/expand
    const sessionFilters = document.getElementById('sessionFilters');
    const sessionFiltersChevron = document.getElementById('sessionFiltersChevron');
    
    if (sessionFilters && sessionFiltersChevron) {
        sessionFilters.addEventListener('show.bs.collapse', function() {
            sessionFiltersChevron.classList.remove('bi-chevron-down');
            sessionFiltersChevron.classList.add('bi-chevron-up');
        });
        
        sessionFilters.addEventListener('hide.bs.collapse', function() {
            sessionFiltersChevron.classList.remove('bi-chevron-up');
            sessionFiltersChevron.classList.add('bi-chevron-down');
        });
    }
});

// Initialize all modals
function initializeModals() {
    console.log('Initializing modals...');
    
    // Initialize session detail modal
    const detailModalElement = document.getElementById('sessionDetailModal');
    if (detailModalElement) {
        console.log('✓ Session detail modal found, initializing...');
        new bootstrap.Modal(detailModalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    } else {
        console.error('✗ Session detail modal not found');
    }
    
    // Initialize blend planner modal
    const blendModalElement = document.getElementById('blendPlannerModal');
    if (blendModalElement) {
        console.log('✓ Blend planner modal found, initializing...');
        new bootstrap.Modal(blendModalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    } else {
        console.error('✗ Blend planner modal not found');
    }
    
    console.log('Modal initialization complete');
}

// Load insight chips for all sessions
function loadInsightChips() {
    const placeholders = document.querySelectorAll('.insight-chips-placeholder');
    placeholders.forEach(placeholder => {
        const sessionId = placeholder.dataset.sessionId;
        loadSessionInsights(sessionId, placeholder);
    });
}

// Load insights for a specific session
function loadSessionInsights(sessionId, placeholder) {
    fetch(`/charging-sessions/${sessionId}/details`)
        .then(response => response.json())
        .then(data => {
            renderInsightChips(placeholder, data.metrics);
        })
        .catch(error => {
            console.error('Error loading insights:', error);
            placeholder.innerHTML = '<div class="text-center text-muted"><small>Error loading insights</small></div>';
        });
}

// Render insight chips using the new chip selector
function renderInsightChips(placeholder, metrics) {
    // Check if we have valid efficiency data
    if (!metrics.efficiency_used || metrics.efficiency_used === null) {
        placeholder.innerHTML = '<div class="text-center text-muted"><small>No efficiency data available</small></div>';
        return;
    }

    // Use the new chip selector to get up to 3 chips
    const chips = selectInlineChips(metrics);
    
    // Render the chips
    renderInlineChips(placeholder, chips);
}



// Show session details modal
function showSessionDetails(sessionId) {
    console.log('showSessionDetails called with sessionId:', sessionId);
    currentSessionId = sessionId;
    
    // Get the modal element
    const modalElement = document.getElementById('sessionDetailModal');
    if (!modalElement) {
        console.error('Session detail modal not found');
        return;
    }
    
    console.log('Modal element found, getting instance...');
    
    // Check if modal is already initialized
    let modal = bootstrap.Modal.getInstance(modalElement);
    if (!modal) {
        console.log('Creating new modal instance...');
        // Create new modal instance
        modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    } else {
        console.log('Using existing modal instance');
    }
    
    console.log('Showing modal...');
    modal.show();
    
    // Load session details
    loadSessionDetails(sessionId);
}

// Load session details
function loadSessionDetails(sessionId) {
    const contentDiv = document.getElementById('sessionDetailContent');
    contentDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    // Update the "Full Detail Page" button link
    const fullDetailBtn = document.getElementById('viewFullDetailBtn');
    if (fullDetailBtn) {
        fullDetailBtn.href = `/session/${sessionId}`;
    }
    
    fetch(`/charging-sessions/${sessionId}/details`)
        .then(response => response.json())
        .then(data => {
            renderSessionDetails(data);
        })
        .catch(error => {
            console.error('Error loading session details:', error);
            contentDiv.innerHTML = '<div class="alert alert-danger">Error loading session details</div>';
        });
}

// Render session details
function renderSessionDetails(data) {
    const template = document.getElementById('sessionDetailTemplate');
    const content = template.content.cloneNode(true);
    
    // Populate summary
    content.querySelector('.session-date').textContent = data.session.date;
    content.querySelector('.session-car').textContent = data.session.car_name;
    content.querySelector('.session-type').textContent = data.session.charge_type;
    content.querySelector('.session-location').textContent = data.session.location;
    content.querySelector('.session-network').textContent = data.session.network || 'N/A';
    content.querySelector('.session-notes').textContent = data.session.notes || 'No notes';
    
    // Show/hide baseline badge
    const baselineBadge = content.querySelector('#baselineBadge');
    if (data.session.is_baseline) {
        baselineBadge.style.display = 'block';
    } else {
        baselineBadge.style.display = 'none';
    }
    
    // Populate key numbers
    content.querySelector('.session-kwh').textContent = `${data.session.charge_delivered_kwh.toFixed(1)} kWh`;
    content.querySelector('.session-total-cost').textContent = `£${data.metrics.total_cost.toFixed(2)}`;
    content.querySelector('.session-cost-per-mile').textContent = `${(data.metrics.cost_per_mile * 100).toFixed(1)}p`;
    content.querySelector('.session-miles-gained').textContent = `${data.metrics.miles_gained.toFixed(1)} mi`;
    
    // Populate battery & power
    content.querySelector('.session-soc-range').textContent = `${data.metrics.battery_added_percent}%`;
    content.querySelector('.session-percent-per-kwh').textContent = `${data.metrics.percent_per_kwh.toFixed(1)}%`;
    content.querySelector('.session-avg-power').textContent = `${data.metrics.avg_power_kw.toFixed(1)} kW`;
    
    // Phase 5.1: Populate loss estimate
    const lossEstimateElement = content.querySelector('.session-loss-estimate');
    if (data.metrics.loss_estimate !== null && data.metrics.loss_estimate !== undefined) {
        const lossValue = data.metrics.loss_estimate;
        const lossText = lossValue >= 0 ? `+${lossValue.toFixed(1)}%` : `${lossValue.toFixed(1)}%`;
        const lossClass = lossValue >= 0 ? 'text-warning' : 'text-success';
        lossEstimateElement.innerHTML = `<span class="${lossClass}">${lossText}</span>`;
    } else {
        lossEstimateElement.textContent = 'N/A';
    }
    
    // Populate context & conditions
    const ambientTempElement = content.querySelector('.session-ambient-temp');
    if (data.ambient_temp_c !== null && data.ambient_temp_c !== undefined) {
        ambientTempElement.textContent = `${data.ambient_temp_c}°C`;
    } else {
        ambientTempElement.textContent = 'Not recorded';
    }
    
    // Populate preconditioning badges
    const preconditioningBadges = content.querySelector('#preconditioningBadges');
    let badgeHtml = '';
    
    if (data.preconditioning_used === true) {
        badgeHtml += '<span class="badge bg-info me-2">Pre-conditioning</span>';
        if (data.preconditioning_events && data.preconditioning_events > 0) {
            badgeHtml += `<span class="badge bg-secondary">×${data.preconditioning_events} events</span>`;
        }
    } else if (data.preconditioning_used === false) {
        badgeHtml += '<span class="badge bg-light text-dark">No pre-conditioning</span>';
    } else {
        badgeHtml += '<span class="badge bg-secondary">Pre-conditioning unknown</span>';
    }
    
    preconditioningBadges.innerHTML = badgeHtml;
    
    // Populate session classification
    const sizeBadge = content.querySelector('.session-size-badge');
    const confidenceBadge = content.querySelector('.session-confidence-badge');
    const confidenceReasons = content.querySelector('.session-confidence-reasons');
    
    // Session size badge
    if (data.metrics.size_bucket) {
        const sizeText = data.metrics.size_bucket.charAt(0).toUpperCase() + data.metrics.size_bucket.slice(1);
        sizeBadge.textContent = sizeText;
        sizeBadge.className = 'badge bg-secondary session-size-badge';
    }
    
    // Phase 5.2: Enhanced confidence badge with detailed reasons
    const confidenceLevel = data.metrics.efficiency_confidence || 'unknown';
    const reasons = data.metrics.confidence_reasons || [];
    
    // Set badge text and color
    const confidenceText = confidenceLevel.charAt(0).toUpperCase() + confidenceLevel.slice(1);
    confidenceBadge.textContent = confidenceText;
    
    switch (confidenceLevel) {
        case 'high':
            confidenceBadge.className = 'badge bg-success session-confidence-badge';
            break;
        case 'medium':
            confidenceBadge.className = 'badge bg-warning session-confidence-badge';
            break;
        case 'low':
            confidenceBadge.className = 'badge bg-danger session-confidence-badge';
            break;
        default:
            confidenceBadge.className = 'badge bg-secondary session-confidence-badge';
    }
    
    // Add detailed tooltip
    if (reasons.length > 0) {
        confidenceBadge.title = `Confidence: ${confidenceLevel}\nIssues: ${reasons.join(', ')}`;
    } else {
        confidenceBadge.title = `Confidence: ${confidenceLevel}`;
    }
    
    // Display confidence reasons below badge (with user-friendly labels)
    if (reasons.length > 0) {
        const reasonsHtml = reasons.map(reason => {
            // Convert technical reasons to user-friendly ones
            const friendlyReason = getUserFriendlyReason(reason);
            const badge = getFriendlyReasonBadgeClass(reason);
            return `<span class="badge ${badge} me-1">${friendlyReason}</span>`;
        }).join('');
        confidenceReasons.innerHTML = `<small>${reasonsHtml}</small>`;
    } else {
        confidenceReasons.innerHTML = '';
    }
    
    // Populate comparative context
    renderComparativeContext(content, data.deltas, data.rolling_averages);
    
    // Populate hints
    renderHints(content, data.hints);
    
    // Update modal content
    document.getElementById('sessionDetailContent').innerHTML = '';
    document.getElementById('sessionDetailContent').appendChild(content);
    
    // Set up button handlers
    setupDetailModalHandlers();
}

// Render comparative context
function renderComparativeContext(content, deltas, rollingAverages) {
    const contextDiv = content.querySelector('#comparativeContext');
    const template = document.getElementById('comparativeContextTemplate');
    const contextContent = template.content.cloneNode(true);
    
    // Populate vs last similar
    if (deltas.vs_last_similar) {
        const deltasDiv = contextContent.querySelector('.comparative-deltas');
        deltasDiv.innerHTML = `
            <div class="mb-2">
                <strong>Cost per mile:</strong> 
                <span class="badge ${deltas.vs_last_similar.cost_per_mile_delta > 0 ? 'bg-danger' : 'bg-success'}">
                    ${deltas.vs_last_similar.cost_per_mile_delta > 0 ? '+' : ''}${(deltas.vs_last_similar.cost_per_mile_delta * 100).toFixed(1)}p
                </span>
            </div>
            <div class="mb-2">
                <strong>Avg power:</strong> 
                <span class="badge ${deltas.vs_last_similar.avg_power_kw_delta > 0 ? 'bg-success' : 'bg-warning'}">
                    ${deltas.vs_last_similar.avg_power_kw_delta > 0 ? '+' : ''}${deltas.vs_last_similar.avg_power_kw_delta.toFixed(1)} kW
                </span>
            </div>
        `;
    }
    
    // Populate vs 30-day average
    if (deltas.vs_30_day_avg) {
        const averagesDiv = contextContent.querySelector('.rolling-averages');
        averagesDiv.innerHTML = `
            <div class="mb-2">
                <strong>Cost per mile:</strong> 
                <span class="badge ${deltas.vs_30_day_avg.cost_per_mile_delta > 0 ? 'bg-danger' : 'bg-success'}">
                    ${deltas.vs_30_day_avg.cost_per_mile_delta > 0 ? '+' : ''}${(deltas.vs_30_day_avg.cost_per_mile_delta * 100).toFixed(1)}p
                </span>
            </div>
            <div class="mb-2">
                <strong>Avg power:</strong> 
                <span class="badge ${deltas.vs_30_day_avg.avg_power_kw_delta > 0 ? 'bg-success' : 'bg-warning'}">
                    ${deltas.vs_30_day_avg.avg_power_kw_delta > 0 ? '+' : ''}${deltas.vs_30_day_avg.avg_power_kw_delta.toFixed(1)} kW
                </span>
            </div>
        `;
    }
    
    contextDiv.appendChild(contextContent);
}

// Render hints
function renderHints(content, hints) {
    const hintsDiv = content.querySelector('#sessionHints');
    const template = document.getElementById('hintTemplate');
    
    if (hints.length === 0) {
        hintsDiv.innerHTML = '<div class="alert alert-info">No hints for this session</div>';
        return;
    }
    
    hints.forEach(hint => {
        const hintContent = template.content.cloneNode(true);
        const alertDiv = hintContent.querySelector('.alert');
        
        // Replace placeholders
        alertDiv.className = alertDiv.className.replace('{type}', hint.type);
        alertDiv.dataset.hintCode = hint.code;
        alertDiv.querySelector('.bi').className = alertDiv.querySelector('.bi').className.replace('{icon}', hint.icon);
        alertDiv.querySelector('.alert-heading').textContent = hint.title;
        alertDiv.querySelector('p').textContent = hint.message;
        
        hintsDiv.appendChild(hintContent);
    });
}

// Setup detail modal handlers
function setupDetailModalHandlers() {
    // Edit button
    document.getElementById('editSessionBtn').onclick = function() {
        if (currentSessionId) {
            window.location.href = `/charging-sessions/${currentSessionId}/edit`;
        }
    };
    
    // Simulate blend button
    document.getElementById('simulateBlendBtn').onclick = function() {
        if (currentSessionId) {
            // Close detail modal and open blend planner
            const detailModal = bootstrap.Modal.getInstance(document.getElementById('sessionDetailModal'));
            if (detailModal) {
                detailModal.hide();
            }
            showBlendPlanner(currentSessionId);
        }
    };
    
    // Setup hint dismissal
    document.querySelectorAll('.hint-item').forEach(hint => {
        hint.querySelector('.btn-close').onclick = function() {
            const hintCode = hint.dataset.hintCode;
            dismissHint(currentSessionId, hintCode);
            hint.remove();
        };
    });
}

// Dismiss hint
function dismissHint(sessionId, hintCode) {
    fetch(`/charging-sessions/${sessionId}/dismiss-hint`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ hint_code: hintCode })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Hint dismissed successfully');
        }
    })
    .catch(error => {
        console.error('Error dismissing hint:', error);
    });
}

// Show blend planner modal
function showBlendPlanner(sessionId, startSoc = null, dcCostPerKwh = null, batteryKwh = null) {
    console.log('showBlendPlanner called with sessionId:', sessionId, 'startSoc:', startSoc, 'dcCostPerKwh:', dcCostPerKwh, 'batteryKwh:', batteryKwh);
    currentSessionId = sessionId;
    
    // Get the modal element
    const modalElement = document.getElementById('blendPlannerModal');
    if (!modalElement) {
        console.error('Blend planner modal not found');
        return;
    }
    
    console.log('Blend planner modal element found, getting instance...');
    
    // Check if modal is already initialized
    let modal = bootstrap.Modal.getInstance(modalElement);
    if (!modal) {
        console.log('Creating new blend planner modal instance...');
        // Create new modal instance
        modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    } else {
        console.log('Using existing blend planner modal instance');
    }
    
    // Pre-fill form if values provided
    if (startSoc !== null) {
        document.getElementById('startSoc').value = startSoc;
        
        // Ensure DC stop is higher than start SoC
        let dcStopSoc = Math.max(startSoc + 15, 60); // At least 15% higher than start, or 60% minimum
        document.getElementById('dcStopSoc').value = dcStopSoc;
        
        // Ensure home target is higher than DC stop, but never above 100%
        let homeTargetSoc = Math.min(Math.max(dcStopSoc + 20, 80), 100); // At least 20% higher than DC stop, or 80% minimum, max 100%
        document.getElementById('homeTargetSoc').value = homeTargetSoc;
    }
    
    if (dcCostPerKwh !== null) {
        document.getElementById('dcCostPerKwh').value = dcCostPerKwh;
    }
    
    if (batteryKwh !== null) {
        document.getElementById('batteryKwh').value = batteryKwh;
    }
    
    // Set default values for other fields
    document.getElementById('dcPowerKw').value = '50';
    document.getElementById('homePowerKw').value = '2.3'; // Default home charger power
    
    // Set home cost to your actual rate (this should come from settings later)
    document.getElementById('homeCostPerKwh').value = '0.2019';
    
    console.log('Showing blend planner modal...');
    modal.show();
    
    // Setup form submission
    setupBlendPlannerForm();
}

// Setup blend planner form
function setupBlendPlannerForm() {
    document.getElementById('blendPlannerForm').onsubmit = function(e) {
        e.preventDefault();
        calculateBlend();
    };
    
    // Setup real-time validation
    setupBlendValidation();
    
    // Setup close button
    document.getElementById('closeBlendBtn').onclick = function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('blendPlannerModal'));
        if (modal) {
            modal.hide();
        }
    };
    
    // Setup copy to notes button
    document.getElementById('copyToNotesBtn').onclick = function() {
        if (currentBlendPlan && currentSessionId) {
            copyBlendToNotes(currentSessionId, currentBlendPlan);
        }
    };
}

// Setup real-time validation for blend planner
function setupBlendValidation() {
    const startSocInput = document.getElementById('startSoc');
    const dcStopSocInput = document.getElementById('dcStopSoc');
    const homeTargetSocInput = document.getElementById('homeTargetSoc');
    
    // Update DC stop when start changes
    startSocInput.addEventListener('input', function() {
        const startSoc = parseInt(this.value) || 0;
        const currentDcStop = parseInt(dcStopSocInput.value) || 65;
        
        // Ensure DC stop is at least 15% higher than start
        if (currentDcStop <= startSoc) {
            const newDcStop = Math.max(startSoc + 15, 60);
            dcStopSocInput.value = newDcStop;
            
            // Also update home target if needed
            const currentHomeTarget = parseInt(homeTargetSocInput.value) || 80;
            if (currentHomeTarget <= newDcStop) {
                homeTargetSocInput.value = Math.min(Math.max(newDcStop + 20, 80), 100);
            }
        }
    });
    
    // Update home target when DC stop changes
    dcStopSocInput.addEventListener('input', function() {
        const dcStopSoc = parseInt(this.value) || 65;
        const currentHomeTarget = parseInt(homeTargetSocInput.value) || 80;
        
        // Ensure home target is at least 20% higher than DC stop
        if (currentHomeTarget <= dcStopSoc) {
            homeTargetSocInput.value = Math.min(Math.max(dcStopSoc + 20, 80), 100);
        }
    });
}

// Calculate blend
function calculateBlend() {
    // Validate SoC values first
    if (!validateBlendInputs()) {
        return;
    }
    
    const formData = new FormData(document.getElementById('blendPlannerForm'));
    const data = {
        start_soc: parseInt(formData.get('startSoc')),
        dc_stop_soc: parseInt(formData.get('dcStopSoc')),
        home_target_soc: parseInt(formData.get('homeTargetSoc')),
        dc_power_kw: parseFloat(formData.get('dcPowerKw')),
        dc_cost_per_kwh: parseFloat(formData.get('dcCostPerKwh')),
        home_cost_per_kwh: parseFloat(formData.get('homeCostPerKwh')),
        home_power_kw: parseFloat(formData.get('homePowerKw')),
        battery_kwh: parseFloat(formData.get('batteryKwh')),
        car_id: getCurrentCarId()
    };
    
    fetch('/blend/plan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        currentBlendPlan = data;
        renderBlendResults(data);
    })
    .catch(error => {
        console.error('Error calculating blend:', error);
        alert('Error calculating blend');
    });
}

// Validate blend inputs
function validateBlendInputs() {
    const startSoc = parseInt(document.getElementById('startSoc').value);
    const dcStopSoc = parseInt(document.getElementById('dcStopSoc').value);
    const homeTargetSoc = parseInt(document.getElementById('homeTargetSoc').value);
    
    if (startSoc >= dcStopSoc) {
        alert('DC Stop SoC must be higher than Start SoC');
        return false;
    }
    
    if (dcStopSoc >= homeTargetSoc) {
        alert('Home Target SoC must be higher than DC Stop SoC');
        return false;
    }
    
    if (homeTargetSoc > 100) {
        alert('Home Target SoC cannot exceed 100%');
        return false;
    }
    
    return true;
}

// Render blend results
function renderBlendResults(data) {
    document.getElementById('dcSummary').textContent = data.formatted.dc_summary;
    document.getElementById('homeSummary').textContent = data.formatted.home_summary;
    document.getElementById('totalSummary').textContent = data.formatted.total_summary;
    
    document.getElementById('blendResults').style.display = 'block';
}

// Copy blend to notes
function copyBlendToNotes(sessionId, blendPlan) {
    fetch('/blend/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: sessionId,
            blend_plan: blendPlan.blend
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Blend plan saved to session notes!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('blendPlannerModal'));
            if (modal) {
                modal.hide();
            }
        } else {
            alert('Error saving blend plan: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error saving blend plan:', error);
        alert('Error saving blend plan');
    });
}

// Get current car ID (simplified - you might want to improve this)
function getCurrentCarId() {
    // Get the car ID from the current session row
    if (currentSessionId) {
        const sessionRow = document.querySelector(`tr[data-session-id="${currentSessionId}"]`);
        if (sessionRow) {
            return sessionRow.dataset.carId;
        }
    }
    // Fallback: get from the first session row
    const firstSession = document.querySelector('tbody tr');
    if (firstSession) {
        return firstSession.dataset.carId;
    }
    return 1; // Default fallback
}
</script>
{% endblock %}
