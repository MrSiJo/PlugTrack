<!-- Blended Charge Planner Content (for inclusion in detail page) -->
<!-- Help text -->
<div class="alert alert-info mb-3">
    <i class="bi bi-lightbulb"></i>
    <strong>Blended Charging Strategy:</strong> Use fast DC charging to get to a reasonable SoC, then finish charging at home where it's cheaper. This saves money while maintaining convenience.
</div>

<form id="blendPlannerForm">
    <div class="row g-3">
        <!-- Input Parameters -->
        <div class="col-md-6">
            <h6 class="text-muted text-uppercase mb-2">Input Parameters</h6>
            
            <div class="mb-3">
                <label for="startSoc" class="form-label">Start SoC (%)</label>
                <input type="number" class="form-control" id="startSoc" name="startSoc" min="0" max="100" required>
            </div>
            
            <div class="mb-3">
                <label for="dcStopSoc" class="form-label">DC Stop SoC (%)</label>
                <input type="number" class="form-control" id="dcStopSoc" name="dcStopSoc" min="0" max="100" required>
                <div class="form-text">Stop DC charging here, then continue at home</div>
            </div>
            
            <div class="mb-3">
                <label for="homeTargetSoc" class="form-label">Home Target SoC (%)</label>
                <input type="number" class="form-control" id="homeTargetSoc" name="homeTargetSoc" min="0" max="100" required>
                <div class="form-text">Final target SoC after home charging</div>
            </div>
        </div>
        
        <!-- Rate Information -->
        <div class="col-md-6">
            <h6 class="text-muted text-uppercase mb-2">Rate Information</h6>
            
            <div class="mb-3">
                <label for="dcCostPerKwh" class="form-label">DC Cost per kWh (£)</label>
                <input type="number" class="form-control" id="dcCostPerKwh" name="dcCostPerKwh" step="0.0001" min="0" required>
                <div class="form-text">Public DC charger rate</div>
            </div>
            
            <div class="mb-3">
                <label for="homeCostPerKwh" class="form-label">Home Cost per kWh (£)</label>
                <input type="number" class="form-control" id="homeCostPerKwh" name="homeCostPerKwh" step="0.0001" min="0" required>
                <div class="form-text">Your home electricity rate</div>
            </div>
            
            <div class="mb-3">
                <label for="dcPowerKw" class="form-label">DC Charger Power (kW)</label>
                <input type="number" class="form-control" id="dcPowerKw" name="dcPowerKw" step="0.1" min="0" required>
                <div class="form-text">DC charger rated power</div>
            </div>
            
            <div class="mb-3">
                <label for="homePowerKw" class="form-label">Home Charger Power (kW)</label>
                <input type="number" class="form-control" id="homePowerKw" name="homePowerKw" step="0.1" min="0" required>
                <div class="form-text">Your home charger power (e.g., 2.3 kW)</div>
            </div>
            
            <div class="mb-3">
                <label for="batteryKwh" class="form-label">Battery Capacity (kWh)</label>
                <input type="number" class="form-control" id="batteryKwh" name="batteryKwh" step="0.1" min="0" required>
                <div class="form-text">Car battery capacity</div>
            </div>
        </div>
    </div>
    
    <!-- Calculate Button -->
    <div class="row mt-3">
        <div class="col-12 text-center">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-calculator"></i> Calculate Blend
            </button>
        </div>
    </div>
</form>

<!-- Results Section -->
<div id="blendResults" class="mt-4" style="display: none;">
    <hr>
    <h6 class="text-muted text-uppercase mb-3">Results</h6>
    
    <div class="row g-3">
        <!-- DC Phase -->
        <div class="col-md-6">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="bi bi-lightning-charge"></i> DC Phase</h6>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <h4 class="text-primary" id="dcSummary">-</h4>
                        <p class="text-muted small mb-0">Energy • Time • Cost</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Home Phase -->
        <div class="col-md-6">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="bi bi-house"></i> Home Phase</h6>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <h4 class="text-success" id="homeSummary">-</h4>
                        <p class="text-muted small mb-0">Energy • Time • Cost</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Total Summary -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-calculator"></i> Total</h6>
                </div>
                <div class="card-body text-center">
                    <h3 class="text-info" id="totalSummary">-</h3>
                    <p class="text-muted mb-0">Blended Cost • Cost per Mile</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="row mt-3">
        <div class="col-12 text-center">
            <button type="button" class="btn btn-outline-primary me-2" id="copyToNotesBtn">
                <i class="bi bi-clipboard"></i> Copy to Notes
            </button>
        </div>
    </div>
</div>

<script>
// Blend planner functionality (inline version)
document.addEventListener('DOMContentLoaded', function() {
    const blendForm = document.getElementById('blendPlannerForm');
    if (blendForm) {
        blendForm.addEventListener('submit', handleBlendCalculation);
    }
});

function handleBlendCalculation(e) {
    e.preventDefault();
    
    // Get form values
    const startSoc = parseFloat(document.getElementById('startSoc').value);
    const dcStopSoc = parseFloat(document.getElementById('dcStopSoc').value);
    const homeTargetSoc = parseFloat(document.getElementById('homeTargetSoc').value);
    const dcCostPerKwh = parseFloat(document.getElementById('dcCostPerKwh').value);
    const homeCostPerKwh = parseFloat(document.getElementById('homeCostPerKwh').value);
    const dcPowerKw = parseFloat(document.getElementById('dcPowerKw').value);
    const homePowerKw = parseFloat(document.getElementById('homePowerKw').value);
    const batteryKwh = parseFloat(document.getElementById('batteryKwh').value);
    
    // Validate inputs
    if (dcStopSoc <= startSoc) {
        alert('DC Stop SoC must be higher than Start SoC');
        return;
    }
    
    if (homeTargetSoc <= dcStopSoc) {
        alert('Home Target SoC must be higher than DC Stop SoC');
        return;
    }
    
    // Calculate energy requirements
    const dcEnergyKwh = (dcStopSoc - startSoc) / 100 * batteryKwh;
    const homeEnergyKwh = (homeTargetSoc - dcStopSoc) / 100 * batteryKwh;
    
    // Calculate time requirements (simplified - no taper modeling)
    const dcTimeHours = dcEnergyKwh / dcPowerKw;
    const homeTimeHours = homeEnergyKwh / homePowerKw;
    
    // Calculate costs
    const dcCost = dcEnergyKwh * dcCostPerKwh;
    const homeCost = homeEnergyKwh * homeCostPerKwh;
    const totalCost = dcCost + homeCost;
    const totalEnergyKwh = dcEnergyKwh + homeEnergyKwh;
    
    // Format time display
    function formatTime(hours) {
        const h = Math.floor(hours);
        const m = Math.round((hours - h) * 60);
        return h > 0 ? `${h}h ${m}m` : `${m}m`;
    }
    
    // Update display
    document.getElementById('dcSummary').textContent = 
        `${dcEnergyKwh.toFixed(1)} kWh • ${formatTime(dcTimeHours)} • £${dcCost.toFixed(2)}`;
    
    document.getElementById('homeSummary').textContent = 
        `${homeEnergyKwh.toFixed(1)} kWh • ${formatTime(homeTimeHours)} • £${homeCost.toFixed(2)}`;
    
    document.getElementById('totalSummary').textContent = 
        `£${totalCost.toFixed(2)} Total • ${(totalCost / totalEnergyKwh * 100).toFixed(1)}p/kWh Average`;
    
    // Show results
    document.getElementById('blendResults').style.display = 'block';
    
    // Setup copy to notes functionality
    const copyBtn = document.getElementById('copyToNotesBtn');
    if (copyBtn) {
        copyBtn.onclick = function() {
            const summary = `Blended Charge Plan: DC ${dcEnergyKwh.toFixed(1)}kWh (${startSoc}%-${dcStopSoc}%) + Home ${homeEnergyKwh.toFixed(1)}kWh (${dcStopSoc}%-${homeTargetSoc}%) = £${totalCost.toFixed(2)} total`;
            navigator.clipboard.writeText(summary).then(() => {
                alert('Plan copied to clipboard!');
            });
        };
    }
}
</script>
